user root;
worker_processes  auto;

error_log  logs/error.log debug;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    ignore_invalid_headers on;

    sendfile        on;
    keepalive_timeout  65;
    
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;

    server {
        listen       8080;
        server_name  localhost;
        # sample handlers
        #location /on_play {
        #    proxy_pass https://www.gyaanhive.com/schedule/on_play;
        #}
        location /on_publish {
            proxy_pass https://www.gyaanhive.com/schedule/on_publish;
        }
      #  location /auth/ {
      #      internal;
      #      proxy_pass              $auth_request_uri?addr=$remote_addr&$hls_args;
      #      proxy_pass_request_body off;
      #      proxy_set_header        X-Real-IP $remote_addr;
      #      proxy_set_header        Content-Length "";
      #      proxy_set_header        X-Original-URI $request_uri;
      #  }
      #  location /hls {
      #      set $auth_request_uri "https://www.gyaanhive.com/schedule/on_play";
      #      set $hls_args $args;
      #      auth_request /auth/;
            # Serve HLS fragments
      #      types {
      #          application/vnd.apple.mpegurl m3u8;
      #          video/mp2t ts;                
      #      }
      #      root /root/;
      #      add_header Cache-Control no-cache;
      #      add_header 'Access-Control-Allow-Origin' '*';
      #  }

        # rtmp stat
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        location /stat.xsl {
            # you can move stat.xsl to a different location
            root /usr/build/nginx-rtmp-module;
        }

        # rtmp control
        location /control {
            rtmp_control all;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
    server {
        listen 443 ssl;
        server_name www.live3.gyaanhive.com;
        root /root/dash;
       
        #ssl on;
        ssl_certificate /etc/letsencrypt/live/www.live3.gyaanhive.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/www.live3.gyaanhive.com/privkey.pem;
        #include /etc/letsencrypt/options-ssl-nginx.conf;
        #ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        # sample handlers
        location /on_publish {
            proxy_pass https://www.gyaanhive.com/schedule/on_publish;
        }
        #location /auth/ {
        #    internal;
        #    proxy_pass              $auth_request_uri?addr=$remote_addr&$extra_args;
        #    proxy_pass_request_body off;
        #    proxy_set_header        X-Real-IP $remote_addr;
        #    proxy_set_header        Content-Length "";
        #    proxy_set_header        X-Original-URI $request_uri;
        #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #}
        #location /hls {
        #    set $auth_request_uri "https://www.gyaanhive.com/schedule/on_play";
        #    set $extra_args $args;
        #    auth_request /auth/;
            # Serve HLS fragments
        #   types {
        #        application/vnd.apple.mpegurl m3u8;
        #        video/mp2t ts;                
        #    }
        #    root /root/;
        #    add_header Cache-Control no-cache;
        #    add_header 'Access-Control-Allow-Origin' '*';
        #}
        location /dash {
            set $extra_args $args;
            root /root/;
            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*';
        }
        location /gyaanhive {
            alias /root/dash;
            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*';
        }
        location /dashABR {
            set $extra_args $args;
            root /root/;
            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*';
        }
        location /gyaanhiveABR {
            alias /root/dashABR;
            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*';
        }
    }

}
rtmp_auto_push on;
rtmp {
    server {
        listen 1935;
        ping 30s;
        notify_method get;
        drop_idle_publisher 5s;
        application gyaanhive {
            live on;
            # sample recorder
            wait_key on;
            wait_video on;

            # dash configuration
            dash on;
            dash_path /root/dash;
            dash_fragment 6s;
            dash_playlist_length 120s;
            dash_cleanup on;
            deny play all;
        }
        application gyaanhiveABR {
            live on;
            # sample recorder
            wait_key on;
            wait_video on;

            # dash configuration
            dash on;
            dash_path /root/dashABR;
            dash_fragment 6s;
            dash_playlist_length 120s;
            dash_cleanup on;
            dash_nested on;
            dash_variant _low bandwidth="500000" width="640" height="360"; 
            dash_variant _med bandwidth="1500000" width="1280" height="720" max; 
            deny play all;
        }
    }
}
