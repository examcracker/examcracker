{% extends "__ecBase.html" %}
<html>
    {% load staticfiles %}

    {% block ImageSlider %}
    {% endblock ImageSlider %}

    {% block jumbotronBlock %}
    {% endblock jumbotronBlock %}

    {% block container %}

    {% block content %}
    <script src="{% static 'access/access.js' %}"></script>
    {% if offuscate %}
    <script src="{% static 'jwplayer/jwplayer_of.js' %}"></script>
    {% else %}
    <script src="{% static 'jwplayer/jwplayer.js' %}"></script>
    {% endif %}
    <script src="{% static 'rest_framework/coreapi-0.1.1.js' %}"></script>

<div class="container-full">
    <div class="row">
            <div class="col-lg-8 col-xs-12 col-sm-12 col-md-12">
                <h2>{{ course.name }}</h2>
                <div id="jwplayerDiv">
                </div>
                <h4>{{ session.name }}</h4>

            </div>
            <div class="col-lg-4 col-xs-12 col-sm-12 col-md-12">
                <h2>Contents</h2>
                <div class="container">
                <div class="panel-group" id="accordion">
                {% for subj, subjdetails in coursedetails.items %}
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h6 class="panel-title">
                                <a role="button" data-toggle="collapse"  aria-expanded="true" data-parent="#accordion" href="#{{ subj }}">
                                    <span class="accordion-title-icon-background collapsed"><i class="accordion-title-icon fas fa-plus"></i></span>
                                    <span class="accordion-title-icon-background expanded"><i class="accordion-title-icon fas fa-minus"></i></span>
                                    <font size="4"> {{ subj }}</font>
                                </a>
                            </h6>
                        </div>
                        <div id="{{ subj }}" class="collapse show">
                        <div class="panel-body">
                    {% for s in subjdetails %}
                    {% for chapid, chapdetails in s.items %}

                    <div class="panel">
                            <div class="panel-heading">
                             <h6 class="panel-title">
                                 <a role="button" data-toggle="collapse" aria-expanded="true" data-parent="#accordion" href="#{{ chapdetails.name }}:{{ subj }}">
                                     <span class="accordion-title-icon-background collapsed"><i class="accordion-title-icon fas fa-plus"></i></span>
                                     <span class="accordion-title-icon-background expanded"><i class="accordion-title-icon fas fa-minus"></i></span>
                                     <font size="3"> {{ chapdetails.name }}</font>
                                 </a>
                             </h6>
                         </div>
                        <div id="{{ chapdetails.name }}:{{ subj }}" class="collapse show">
                            <div class="panel-child-body">
                                <div class="list-group">
                        {% for sess in chapdetails.sessions %}
                        {% if sess.id == session.id %}
                        <a href="{% url 'course:playSession' chapid sess.id %}" class="selected-item box-no-border list-group-item">
                            <i class="fa fa-pause fa-fw" style="padding-right:10px"></i><font size="2"> {{ sess.name }}</font></a>
                        {% else %}
                        <a href="{% url 'course:playSession' chapid sess.id %}" class="box-no-border list-group-item">
                            <i class="fa fa-play fa-fw" style="padding-right:10px"></i><font size="2"> {{ sess.name }}</font></a>
                        {% endif %}
                        {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endfor %}
                </div>
                </div>
        </div>
                {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

    <script type="text/javascript">
    function getUTCTimeSecs() {
     return new Date().getTime()/1000;
    }

    var coreapi = window.coreapi;
    var client = new coreapi.Client();

    var lasttime = 0;
    var lastplayertime = 0;
    var now = 0;
    var nowplayer = 0;
    var durationplayed = 0;
    var lastdurationplayed = 0;

    function update() {
      var url = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/course/updateDurationPlayed/" + "{{enrolledcourseid}}" + "/" + Math.floor(durationplayed);
      client.get(url)
            .then(function (data) {})
            .catch(function (error) {alert(error);});
    }

    window.onload = function() {
        var offuscate = "{{offuscate}}";

        var isOwner = "{{isOwner}}";
        if (isOwner == "yes") {
            jwplayer("jwplayerDiv").setup({
                file: "{{ signedurl }}"
            });
        }  else {
            var accepted = 0;
            var tracktime = 0;

            if ("{{disableaccess}}") {
              accepted = 1;
              tracktime = 1;
            } else {
              var deviceJSON = "DUMMYSTRING";
              var url = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/access/allow/{{user.id}}/" + deviceJSON;
              var xmlHttp = new XMLHttpRequest();
              xmlHttp.open("GET", url, false);
              xmlHttp.send(null);
              accepted = (/True/).test(xmlHttp.responseText);
            }

            if (accepted) {
                jwplayer("jwplayerDiv").setup({file: "{{ signedurl }}"});
                if(tracktime) {
                  var _0x4bf7=['position','abs','log','time'];(function(_0xc60a23,_0x157c7b){var _0x105539=function(_0x35fc2c){while(--_0x35fc2c){_0xc60a23['push'](_0xc60a23['shift']());}};_0x105539(++_0x157c7b);}(_0x4bf7,0x14b));var _0x177d=function(_0x55ad27,_0x231945){_0x55ad27=_0x55ad27-0x0;var _0x2ca301=_0x4bf7[_0x55ad27];return _0x2ca301;};jwplayer()['on'](_0x177d('0x0'),_0x250cd6=>{now=getUTCTimeSecs();nowplayer=_0x250cd6[_0x177d('0x1')];if(lasttime==0x0){lastplayertime=nowplayer;lasttime=now;return;}var _0x38d0d8=nowplayer-lastplayertime;if(_0x38d0d8<0x0){lastplayertime=nowplayer;lasttime=now;return;}var _0x51aaa7=now-lasttime;if(Math[_0x177d('0x2')](_0x51aaa7-_0x38d0d8)<0x3){durationplayed=durationplayed+_0x38d0d8;lastplayertime=nowplayer;lasttime=now;console[_0x177d('0x3')](durationplayed);if(durationplayed-lastdurationplayed>0x6){lastdurationplayed=durationplayed;update();}return;}if(_0x51aaa7>_0x38d0d8){durationplayed=durationplayed+_0x38d0d8;}console[_0x177d('0x3')](durationplayed);lastplayertime=nowplayer;lasttime=now;if(durationplayed-lastdurationplayed>0x6){lastdurationplayed=durationplayed;update();}});
                }
            }
            else {
                  alert("This device is unknown. Authenticate yourself by the link sent to your email.");
            }
        }
    }


    </script>
    {%  endblock %}
    {%  endblock container %}
</html>

