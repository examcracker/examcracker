{% load staticfiles %}   
<style>
    table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
    font-size: small;
    table-layout: fixed;
}
</style>

<div class="container">
    <form action="{% url 'provider:create_course' %}" method="POST" enctype="multipart/form-data" id="contentForm" > {% csrf_token %}
{% for courseName,courseDetails in course_detail.items %}
    <h5>{{courseName}}</h5>
        <div class="card bg-light text-dark">
            <div class="course-header">
            </div>
            <div class="card-body">
                <div class="container">
                    <div id="accordianChapters-{{courseName}}">
                    {% for item in courseDetails %}
                    {% for chapid, value in item.items %}
                    <div class="card" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="card{{chapid}}">
                        <div class="card-header">
                            <a class="card-link mr-3" data-toggle="collapse" data-parent="#accordianChapters-{{courseName}}" href="#c{{chapid}}">{{value.name}}</a>
                            {% if not editContentDisable %}
                            <button type="button" onclick="deleteChapter(this)" class="btn-xs btn-info float-right" id="{{courseName}}-deleteChapter">Delete</button>
                            <span class="badge badge-secondary" id="span-badge-sessionCnt-{{chapid}}">{{value.sessions|length}} <i class="fa fa-video-camera"></i></span>
                            <span class="badge badge-warning" title="Contains unpublished Sessions" id="span-badge-publishedStatus-{{chapid}}" {% if not value.hasUnPublishedSessions %} hidden {% endif %}><i class="fa fa-exclamation-triangle"></i></span>
                            {% endif %}
                        </div>
                        <div id="c{{chapid}}" class="collapse">
                            <div class="card-body" id="{{chapid}}">
                                <input id="fileupload{{chapid}}" type="file" name="video" multiple style="display: none;" data-url="{% url 'provider:upload_video' %}">
                                <input type="hidden" value="{{chapid}}-{{courseName}}" name="lcids" />
                                <div class="row">
                                    <input type="text" class="form-control" name="cd[]" placeholder="Summary" value = "{{value.name}}" >
                                    <input type="hidden" class="form-control" name="cpids[]" value = "{{chapid}}" >
                                </div>
                                <div class="row">
                                    {% if not editContentDisable %}
                                    <div class="col-auto mt-2 mb-2"><button type="button" onclick="addLecture(this,'{{ editCourse.id }}','{{ courseName }}')" class="btn-xs btn-primary float-right">Add Session</button></div>
                                    <div class="col-auto mt-2 mb-2"><button type="button" onclick="addLectureFromLibrary(this,'{{ courseName }}')" class="btn-xs btn-default float-right">Select existing Session</button></div>
                                    {% endif %}
                                </div>
                            <div class="container" id="lecturesHere-{{chapid}}">
                                {% for session in value.sessions %}
                                <!-- lectures here -->
                                <hr>
                                <div class="row" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="cp{{forloop.parentloop.parentloop.counter}}lc{{session.id}}">
                                        <div class="col-xs-2 col-sm-2" id="lectureFound">
                                            {% if not session.published or editContentDisable  %}
                                            <span title="Delete This Session"><button type="button" class="btn btn-outline-secondary" onclick="deleteLecture(this)"><i class="fa fa-trash"></i></button></span>
                                            {% else %}
                                            <button type="button" class="btn btn-outline-info" disabled><i class="fa fa-ban" data-toggle="tooltip" data-placement="top" title="Published session cant be deleted"></i></button>
                                            {% endif %}
                                        </div>
                                        <div class="col-xs-3 col-sm-3" id="{{courseName}};{{chapid}};{{forloop.counter}}">
                                                Session {{forloop.counter}}        
                                        </div>
                                        <div class="col-xs-7 col-sm-7">
                                            <a href="{% url 'course:playSession' chapid session.id %}" >
                                                <i class="fa fa-play fa-fw" ></i>
                                                {{ session.name }}
                                            </a>
                                            <input type="hidden" name ="lecPub[{{chapid}}][]" value="{{session.published}}">
                                            <input type="hidden" name ="lec[{{chapid}}][]" value="{{session.id}}">
                                        </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endfor %}
                    </div>
                </div>
            </div>
        </div>
      <input type="hidden" value="true" name="isCourseContent" />
      <input type="hidden" value="{{editCourse.id}}" name="courseId"/>
    {% if not editContentDisable %}
      <button type="button" onclick="addChapter(this)" class="btn btn-info btn-lg mt-4" id="{{courseName}}-addChapter">Add Chapter</button>
     {% endif  %}
<hr class="my-4">
{% endfor %}
</form>

    <div class="modal" id="modal-progress" tabindex="-2" role="dialog" aria-labelledby="uploadProgress" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modal-progress">Uploading...</h4>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

  <!-- Modal to add lectures from library -->
  <div class="modal fade modal-lg" id="sessionLibraryModel" tabindex="-1" role="dialog" aria-labelledby="sessionLibrary" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sessionLibraryModel">Select Sessions</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <ul>
            {% for ss in sessionsBySubjects %}
            <li>
            <input type="checkbox" class="form-check-input" name="sCheckBox[]" id="{{ss.id}}" value="{{ss.name}}">
            <label class="form-check-label" for="{{ss.id}}">{{ss.name}}</label>
            </li>
            {% endfor %}
            </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="selectlecturebutton" type="button">Select Sessions</button>
        </div>
      </div>
    </div>
  </div>
</div>


<script src="{% static 'fileUploader/js/jquery-3.1.1.min.js' %}"></script>
<script src="{% static 'fileUploader/js/jquery-file-upload/vendor/jquery.ui.widget.js' %}"></script>
<script src="{% static 'fileUploader/js/jquery-file-upload/jquery.iframe-transport.js' %}"></script>
<script src="{% static 'fileUploader/js/jquery-file-upload/jquery.fileupload.js' %}"></script>


<script>
    $(function () {
  $('[data-toggle="tooltip"]').tooltip()
})
    var chapCnt = Math.floor((Math.random() * 2000) + 1000);;
    var myMap = new Map();
    $(function(){
        var chapterStr = "accordianChapters-";
        queryselect = '[id^="'+chapterStr+'"]';
        var query = document.querySelectorAll(queryselect);
        for(i=0;i<query.length;i++) {
            var q = query[i].id;
            var subj = q.split('-')[1]
            myMap.set(subj,query[i].children.length+1);
            chapCnt = chapCnt +  myMap.get(subj);
        }
});

    function addChapter(elmnt) {
        var subject = elmnt.id.split("-")[0]
        var fatherid = "accordianChapters-"+subject
        var fatherOfChapter = document.getElementById(fatherid);
        var currentChapCnt = fatherOfChapter.children.length;

        var chapterNum = myMap.get(subject);
        myMap.set(subject,myMap.get(subject) + 1);
        var id = chapCnt;
        var lcidval = id + '-' + subject;
        var lectureFatherId = 'lecturesHere-'+id;
        var fileTag = $("<input id=\"fileupload"+id+"\" type=\"file\" name=\"video\" multiple style=\"display: none;\" data-url=\"{% url 'provider:upload_video' %}\" >");
        var myChapter = $('<div class="card" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="card'+id+'"><div class="card-header"><a class="card-link mr-3" data-toggle="collapse" data-parent="#accordianChapters'+subject+'" href="#c'+id+'">Chapter '+chapterNum+'</a><button type="button" onclick="deleteChapter(this)" class="btn-xs btn-info float-right" id="'+subject+'-deleteChapter">Delete</button><span class="badge badge-secondary" id="span-badge-sessionCnt-'+id+'">0 <i class="fa fa-video-camera"></i></span><span class="badge badge-warning" title="Contains unpublished Sessions" id="span-badge-publishedStatus-'+id+'" hidden><i class="fa fa-exclamation-triangle"></i></span></div><div id="c'+id+'" class="collapse"><div class="card-body" id="'+id+'"><input type="hidden" value="'+lcidval+'" name="lcids" /><div class="row"><input type="text" class="form-control" name="cd[]" placeholder="Enter Chapter Description" value = "Chapter '+chapterNum+'" /></div><div class="row"><div class="col-auto mt-2 mb-2"><button type="button" onclick="addLecture(this,\'{{ editCourse.id }}\',\'{{ editCourse.name }}\')" class="btn-xs btn-primary float-right">Add Session</button></div><div class="col-auto mt-2 mb-2"><button type="button" onclick="addLectureFromLibrary(this,\'{{ editCourse.name }}\')" class="btn-sm btn-default float-right">Choose existing Session</button></div></div><div class="container" id="'+lectureFatherId+'"></div></div></div></div>');
        //var myChapter = $('<div class="card" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="card'+id+'"><div class="card-header"><a class="card-link" data-toggle="collapse" data-parent="#accordianChapters'+subject+'" href="#c'+id+'">Chapter '+chapterNum+'</a><button type="button" onclick="deleteChapter(this)" class="btn-xs btn-info float-right" id="'+subject+'-deleteChapter">Delete</button></div><div id="c'+id+'" class="collapse"><div class="card-body" id="'+id+'"><input type="hidden" value="'+lcidval+'" name="lcids" /><div class="row"><input type="text" class="form-control" name="cd[]" placeholder="Enter Chapter Description" value = "Chapter '+chapterNum+'" /></div><div class="row"><div class="col-auto mt-2 mb-2"><button type="button" onclick="addLecture(this,\'{{ editCourse.id }}\',\'{{ editCourse.name }}\')" class="btn-xs btn-primary float-right">Add Session</button></div><div class="col-auto mt-2 mb-2"><button type="button" onclick="addLectureFromLibrary(this,\'{{ editCourse.name }}\')" class="btn-sm btn-default float-right">Choose existing Session</button></div></div><div class="container" id="'+lectureFatherId+'"></div></div></div></div>');
        myChapter.appendTo(fatherOfChapter);
        fileTag.appendTo($("#"+id+".card-body"));
        chapCnt = chapCnt+1;
    }
     function deleteChapter(elmnt) {
 
        var subject = elmnt.id.split("-")[0];
        var fatherid = "accordianChapters-"+subject;
        var fatherOfChapter = document.getElementById(fatherid);

        var el = elmnt;
        while (el.className != 'card') {
            // Increment the loop to the parent node
            el = el.parentNode;
        }

        var lectureFound = el.querySelector('.card-body .container .row #lectureFound');
        if (lectureFound) {
            alert('Cannot Delete !! It has sessions');
        }
        else {
            fatherOfChapter.removeChild(el);
        }
    }
    function deleteLecture(elmnt) {
        var l_elem = elmnt;
         while (l_elem.className != 'row') {
            // Increment the loop to the parent node
            l_elem = l_elem.parentNode;
        }
        var c_elem = l_elem;
        while (c_elem.className != 'container') {
            // Increment the loop to the parent node
            c_elem = c_elem.parentNode;
        }
        var idOfLectureFather = c_elem.id;
        idOfLectureFather = idOfLectureFather.split("-")[1];
        var lecCnt = c_elem.querySelectorAll('.row #lectureFound');
        lecCnt = lecCnt.length-1;
        c_elem.removeChild(l_elem);
        var spanBadgeSessionCnt = document.getElementById('span-badge-sessionCnt-'+idOfLectureFather);
        spanBadgeSessionCnt.innerHTML = lecCnt + ' <i class="fa fa-video-camera"></i>';
        
        lecCnt = c_elem.querySelectorAll('.row #lectureFound .fa-trash');
        if (!lecCnt.length) {
            var spanBadgeChapterPublishedStatus = document.getElementById('span-badge-publishedStatus-'+idOfLectureFather);
            spanBadgeChapterPublishedStatus.setAttribute('hidden',true);
        }
    }

    function addLecture(elmnt,courseid,coursename) {
         var el = elmnt;
         while (el.className != 'card-body') {
            // Increment the loop to the parent node
            el = el.parentNode;
        }
         var id = el.children.length-4;
         var cname = el.id;
         $("#fileupload"+cname).click();
         $("#fileupload"+cname).fileupload({
            dataType: 'json',
            add: function (e, data) {
                var goUpload = true;
                var uploadFile = data.files[0];
                if (!(/\.(mp4|mpeg|mpg|avi|asf)$/i).test(uploadFile.name)) {
                    alert(uploadFile.name + ' is not a valid video file. You must select valid video file');
                    goUpload = false;
                }
                /*if (uploadFile.size > 0) {
                    alert('Invalid file size');
                    goUpload = false;
                }*/
                if (goUpload == true) {
                    data.submit();
                }
            },
            formData: [
                    { name: "coid", value: courseid},
                    { name: "csrfmiddlewaretoken", value: "{{ csrf_token }}"}
                ],
            sequentialUploads: true,  /* 1. SEND THE FILES ONE BY ONE */
            start: function (e) {  /* 2. WHEN THE UPLOADING PROCESS STARTS, SHOW THE MODAL */
                $("#modal-progress").modal("show");
            },
            stop: function (e) {  /* 3. WHEN THE UPLOADING PROCESS FINALIZE, HIDE THE MODAL */
                $(".progress-bar").css({"width": "0%"});
                $("#modal-progress").modal("hide");
            },
            progressall: function (e, data) {  /* 4. UPDATE THE PROGRESS BAR */
                var progress = parseInt(data.loaded / data.total * 100, 10);
                var strProgress = progress + "%";
                $(".progress-bar").css({"width": strProgress});
                $(".progress-bar").text(strProgress);
            },
            done: function (e, data) {
                if (data.result.is_valid) {
                    var queryselect = coursename+';'+cname+';';
                    queryselect = '[id^="'+queryselect+'"]';
                    var query = document.querySelectorAll(queryselect)
                    if (query && query.length > 0) {
                        var last = query[query.length- 1].id;
                        id = last.split(";")[2];
                        id = parseInt(id)+1;
                    }
                    var lectureid = coursename+';'+cname+';'+id;
                    var lecture = $('<hr><div class="row" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="cp'+cname+'lc'+id+'""><input type="hidden" name ="lecPub['+cname+'][]" value="False"><input type="hidden" name ="lec['+cname+'][]" value="'+data.result.videoId+'"><div class="col-xs-2 col-sm-2" id="lectureFound"><span title="Delete This Session"><button type="button" class="btn btn-outline-secondary" onclick="deleteLecture(this)"><i class="fa fa-trash"></i></button></span></div><div class="col-xs-3 col-sm-3" id="'+lectureid+'">Session '+id+'</div><div class="col-xs-7 col-sm-7">'+data.result.videoName+'</div></div>');
                    var lectureFatherid = "lecturesHere-"+cname;
                    var lectureFather = document.getElementById(lectureFatherid);
                    lecture.appendTo(lectureFather);
                    id = id+1;
                    var spanBadgeSessionCnt = document.getElementById('span-badge-sessionCnt-'+cname);
                    spanBadgeSessionCnt.innerHTML = query.length+1 + ' <i class="fa fa-video-camera"></i>';
                    var spanBadgeChapterPublishedStatus = document.getElementById('span-badge-publishedStatus-'+cname);
                    spanBadgeChapterPublishedStatus.removeAttribute('hidden');
                    
                }
            }
    });

    }
    
    var gElm;
    var gcname;
    var gid=0;
    var gcoursename;
    function addLectureFromLibrary(elmnt,coursename) {
        gcoursename = coursename;
        var lChapter = elmnt;
        while (lChapter.className != 'card-body') {
            // Increment the loop to the parent node
            lChapter = lChapter.parentNode;
        }
        var id = lChapter.children.length-4;
        gid = id;
        var cname = lChapter.id;
        gcname = cname;
        gElm = lChapter;
         $("#sessionLibraryModel").modal("show");
    }
    $("#selectlecturebutton").click(function(e){
             e.preventDefault();
            $("#sessionLibraryModel").modal("hide");
            $('input[name="sCheckBox[]"]').each(function() { 
             var lval = $(this).val();
             var lid = $(this).attr('id');
             if ($(this).prop('checked')) {
                
                var queryselect = gcoursename+';'+gcname+';';
                queryselect = '[id^="'+queryselect+'"]';
                var query = document.querySelectorAll(queryselect);
                if (query && query.length > 0) {
                    var last = query[query.length- 1].id;
                    gid = last.split(";")[2];
                    gid = parseInt(gid)+1;
                }
                var lectureid = gcoursename+';'+gcname+';'+gid;
                var lecture = $('<hr><div class="row" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="cp'+gcname+'lc'+gid+'""><input type="hidden" name ="lecPub['+gcname+'][]" value="False"><input type="hidden" name ="lec['+gcname+'][]" value="'+lid+'"><div class="col-xs-2 col-sm-2" id="lectureFound"><span title="Delete This Session"><button type="button" class="btn btn-outline-secondary" onclick="deleteLecture(this)"><i class="fa fa-trash"></i></button></span></div><div class="col-xs-3 col-sm-3" id="'+lectureid+'">Session '+gid+'</div><div class="col-xs-7 col-sm-7">'+lval+'</div></div>');
                var lectureFatherid = "lecturesHere-"+gcname;
                var lectureFather = document.getElementById(lectureFatherid);
                lecture.appendTo(lectureFather);
                gid = gid+1;
                $(this).prop("checked", false);
                var spanBadgeSessionCnt = document.getElementById('span-badge-sessionCnt-'+gcname);
                spanBadgeSessionCnt.innerHTML = query.length+1 + ' <i class="fa fa-video-camera"></i>';
                var spanBadgeChapterPublishedStatus = document.getElementById('span-badge-publishedStatus-'+gcname);
                spanBadgeChapterPublishedStatus.removeAttribute('hidden');
             }
             });
            });
  </script>