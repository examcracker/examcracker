{% load staticfiles %}   
<style>
    table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
    font-size: small;
    table-layout: fixed;
}
</style>

<div class="container">
    <form action="{% url 'provider:create_course' %}" method="POST" enctype="multipart/form-data" id="contentForm" > {% csrf_token %}
{% for courseName,courseDetails in course_detail.items %}
    <h5>{{courseName}}</h5>
        <div class="card bg-light text-dark">
            <div class="course-header">
            </div>
            <div class="card-body">
                <div class="container">
                    <div id="accordianChapters-{{courseName}}">
                    {% for item in courseDetails %}
                    {% for chapid, value in item.items %}
                    <div class="card" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="card{{chapid}}">
                        <div class="card-header">
                            <a class="card-link" data-toggle="collapse" data-parent="#accordianChapters-{{courseName}}" href="#c{{chapid}}">{{value.name}}</a>
                            {% if not editContentDisable %}
                            <button type="button" onclick="deleteChapter(this)" class="btn-xs btn-info float-right" id="{{courseName}}-deleteChapter">Delete</button>
                            {% endif %}
                        </div>
                        <div id="c{{chapid}}" class="collapse">
                            <div class="card-body" id="{{chapid}}">
                                <input id="fileupload{{chapid}}" type="file" name="video" multiple style="display: none;" data-url="{% url 'provider:upload_video' %}">
                                <input type="hidden" value="{{chapid}}-{{courseName}}" name="lcids" />
                                <div class="row">
                                    <input type="text" class="form-control" name="cd[]" placeholder="Summary" value = "{{value.name}}" >
                                    <input type="hidden" class="form-control" name="cpids[]" value = "{{chapid}}" >
                                </div>
                                <div class="row">
                                    {% if not editContentDisable %}
                                    <div class="col-auto mt-2 mb-2"><button type="button" onclick="addLecture(this,'{{ editCourse.id }}','{{ courseName }}')" class="btn-xs btn-primary float-right">Add Session</button></div>
                                    <div class="col-auto mt-2 mb-2"><button type="button" onclick="addLectureFromLibrary(this,'{{ courseName }}')" class="btn-xs btn-default float-right">Select existing Session</button></div>
                                    {% endif %}
                                </div>
                                {% for session in value.sessions %}
                                <!-- lectures here -->
                                <div class="row" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="cp{{forloop.parentloop.parentloop.counter}}lc{{session.id}}">
                                    <table id="{{courseName}};{{chapid}};{{forloop.counter}}">
                                        <tr>
                                            {% if not session.published %}
                                            {% if not editContentDisable %}
                                            <td><button type="button" class="btn" onclick="deleteLecture(this)"><i class="fa fa-trash fa-fw"></i></button></td>
                                            {% endif %}
                                            {% endif %}
                                            <td style="font-weight:bold">Session {{forloop.counter}}</td>
                                            <td>
                                                <a href="{% url 'course:playSession' chapid session.id %}" >
                                                <i class="fa fa-play fa-fw" ></i>
                                                {{ session.name }}
                                                </a>
                                                <input type="hidden" name ="lecPub[{{chapid}}][]" value="{{session.published}}">
                                                <input type="hidden" name ="lec[{{chapid}}][]" value="{{session.id}}">
                                            </td>
                                        </tr>
                                    </table>
                                
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endfor %}
                    </div>
                </div>
            </div>
        </div>
      <input type="hidden" value="true" name="isCourseContent" />
      <input type="hidden" value="{{editCourse.id}}" name="courseId"/>
    {% if not editContentDisable %}
      <button type="button" onclick="addChapter(this)" class="btn btn-info btn-lg mt-4" id="{{courseName}}-addChapter">Add Chapter</button>
     {% endif  %}
<hr class="my-4">
{% endfor %}
    {% if not editContentDisable %}
    <button type="submit"  class="btn btn-info btn-lg float-right mt-4" id="saveAllChanges">Save</button>
    {% endif %}
</form>

    <div class="modal fade" id="modal-progress" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Uploading...</h4>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Button trigger modal 
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
    Launch demo modal
  </button>
-->
  <!-- Modal to add lectures from library -->
  <div class="modal fade modal-lg" id="sessionLibraryModel" tabindex="-1" role="dialog" aria-labelledby="sessionLibrary" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sessionLibraryModel">Select Sessions</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <ul>
            {% for ss in sessionsBySubjects %}
            <li>
            <input type="checkbox" class="form-check-input" name="sCheckBox[]" id="{{ss.id}}" value="{{ss.name}}">
            <label class="form-check-label" for="{{ss.id}}">{{ss.name}}</label>
            </li>
            {% endfor %}
            </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="selectlecturebutton" type="button">Select Sessions</button>
        </div>
      </div>
    </div>
  </div>
</div>


<script src="{% static 'fileUploader/js/jquery-3.1.1.min.js' %}"></script>
<script src="{% static 'fileUploader/js/jquery-file-upload/vendor/jquery.ui.widget.js' %}"></script>
<script src="{% static 'fileUploader/js/jquery-file-upload/jquery.iframe-transport.js' %}"></script>
<script src="{% static 'fileUploader/js/jquery-file-upload/jquery.fileupload.js' %}"></script>


<script>
    var chapCnt = 1;
    var myMap = new Map();
    $(function(){
        var chapterStr = "accordianChapters-";
        queryselect = '[id^="'+chapterStr+'"]';
        var query = document.querySelectorAll(queryselect);
        for(i=0;i<query.length;i++) {
            var q = query[i].id;
            var subj = q.split('-')[1]
            myMap.set(subj,query[i].children.length + 1);
            chapCnt = chapCnt +  myMap.get(subj);
        }
});

    function addChapter(elmnt) {
        var subject = elmnt.id.split("-")[0]
        var fatherid = "accordianChapters-"+subject
        var fatherOfChapter = document.getElementById(fatherid);
        var currentChapCnt = fatherOfChapter.children.length;
        //if (currentChapCnt > chapCnt) {
        //    chapCnt=currentChapCnt;
        //}
        var chapterNum = myMap.get(subject);
        myMap.set(subject,myMap.get(subject) + 1);
        var id = chapCnt;
        var lcidval = id + '-' + subject;
        var fileTag = $("<input id=\"fileupload"+id+"\" type=\"file\" name=\"video\" multiple style=\"display: none;\" data-url=\"{% url 'provider:upload_video' %}\" >");
        var myChapter = $('<div class="card" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="card'+id+'"><div class="card-header"><a class="card-link" data-toggle="collapse" data-parent="#accordianChapters'+subject+'" href="#c'+id+'">Chapter '+chapterNum+'</a><button type="button" onclick="deleteChapter(this)" class="btn-xs btn-info float-right" id="'+subject+'-deleteChapter">Delete</button></div><div id="c'+id+'" class="collapse"><div class="card-body" id="'+id+'"><input type="hidden" value="'+lcidval+'" name="lcids" /><div class="row"><input type="text" class="form-control" name="cd[]" placeholder="Enter Chapter Description" value = "Chapter '+chapterNum+'" /></div><div class="row"><div class="col-auto mt-2 mb-2"><button type="button" onclick="addLecture(this,\'{{ editCourse.id }}\',\'{{ editCourse.name }}\')" class="btn-xs btn-primary float-right">Add Session</button></div><div class="col-auto mt-2 mb-2"><button type="button" onclick="addLectureFromLibrary(this,\'{{ editCourse.name }}\')" class="btn-sm btn-default float-right">Choose existing Session</button></div></div></div></div></div>');
        myChapter.appendTo(fatherOfChapter);
        fileTag.appendTo($("#"+id+".card-body"));
        chapCnt = chapCnt+1;
    }
     function deleteChapter(elmnt) {
 
        var subject = elmnt.id.split("-")[0];
        var fatherid = "accordianChapters-"+subject;
        var fatherOfChapter = document.getElementById(fatherid);

        var el = elmnt;
        while (el.className != 'card') {
            // Increment the loop to the parent node
            el = el.parentNode;
        }

        var lectureFound = el.querySelector('.card-body .row table');
        if (lectureFound) {
            alert('Cannot Delete !! It has sessions');
        }
        else {
            fatherOfChapter.removeChild(el);
            //chapCnt = chapCnt-1;
        }
    }
    function deleteLecture(elmnt) {
        var l_elem = elmnt;
         while (l_elem.className != 'row') {
            // Increment the loop to the parent node
            l_elem = l_elem.parentNode;
        }
        var c_elem = l_elem;
        while (c_elem.className != 'card-body') {
            // Increment the loop to the parent node
            c_elem = c_elem.parentNode;
        }
        c_elem.removeChild(l_elem);
    }

    function addLecture(elmnt,courseid,coursename) {
         var el = elmnt;
         while (el.className != 'card-body') {
            // Increment the loop to the parent node
            el = el.parentNode;
        }
        
         var id = el.children.length-3;
         var cname = el.id;
         $("#fileupload"+cname).click();
         $("#fileupload"+cname).fileupload({
            dataType: 'json',
            formData: [
                    { name: "coid", value: courseid},
                    { name: "csrfmiddlewaretoken", value: "{{ csrf_token }}"}
                ],
            sequentialUploads: true,  /* 1. SEND THE FILES ONE BY ONE */
            start: function (e) {  /* 2. WHEN THE UPLOADING PROCESS STARTS, SHOW THE MODAL */
                $("#modal-progress").modal("show");
            },
            stop: function (e) {  /* 3. WHEN THE UPLOADING PROCESS FINALIZE, HIDE THE MODAL */
                $("#modal-progress").modal("hide");
            },
            progressall: function (e, data) {  /* 4. UPDATE THE PROGRESS BAR */
                var progress = parseInt(data.loaded / data.total * 100, 10);
                var strProgress = progress + "%";
                $(".progress-bar").css({"width": strProgress});
                $(".progress-bar").text(strProgress);
            },
            done: function (e, data) {
                if (data.result.is_valid) {
                    var queryselect = coursename+';'+cname+';';
                    queryselect = '[id^="'+queryselect+'"]';
                    var query = document.querySelectorAll(queryselect)
                    if (query && query.length > 0) {
                        var last = query[query.length- 1].id;
                        id = last.split(";")[2];
                        id = parseInt(id)+1;
                    }
                    var lectureid = coursename+';'+cname+';'+id;
                    var lecture = $('<div class="row" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="cp'+cname+'lc'+id+'"><input type="hidden" name ="lecPub['+cname+'][]" value="False"><input type="hidden" name ="lec['+cname+'][]" value="'+data.result.videoId+'"><table id="'+lectureid+'"><tr><td><button type="button" class="btn" onclick="deleteLecture(this)"><i class="fa fa-trash fa-fw"></i></button></td><td style="font-weight:bold">Session '+id+'</td><td>'+data.result.videoName+'</td></tr></table></div>');
                    //var lecture = $('<div class="row"><table><tr><td>Lecture '+id+'</td><td><div class="input-group"><div class="custom-file"><input type="file" name ="lc['+cname+'][]" class="custom-file-input"><label class="custom-file-label" >Choose Lecture </label></div></div></td></tr></table></div>');
                    lecture.appendTo(el);
                    id = id+1;
                    
                }
            }
    });

    }
    
    var gElm;
    var gcname;
    var gid=0;
    var gcoursename;
    function addLectureFromLibrary(elmnt,coursename) {
        gcoursename = coursename;
        var lChapter = elmnt;
        while (lChapter.className != 'card-body') {
            // Increment the loop to the parent node
            lChapter = lChapter.parentNode;
        }
        var id = lChapter.children.length-3;
        gid = id;
        var cname = lChapter.id;
        gcname = cname;
        gElm = lChapter;
         $("#sessionLibraryModel").modal("show");
    }
    $("#selectlecturebutton").click(function(e){
             e.preventDefault();
            $("#sessionLibraryModel").modal("hide");
            $('input[name="sCheckBox[]"]').each(function() { 
             var lval = $(this).val();
             var lid = $(this).attr('id');
             if ($(this).prop('checked')) {
                
                var queryselect = gcoursename+';'+gcname+';';
                queryselect = '[id^="'+queryselect+'"]';
                var query = document.querySelectorAll(queryselect);
                if (query && query.length > 0) {
                    var last = query[query.length- 1].id;
                    gid = last.split(";")[2];
                    gid = parseInt(gid)+1;
                }
                var lectureid = gcoursename+';'+gcname+';'+gid;
                var lecture = $('<div class="row" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" id="cp'+gcname+'lc'+gid+'"><input type="hidden" name ="lecPub['+gcname+'][]" value="False"><input type="hidden" name ="lec['+gcname+'][]" value="'+lid+'"><table id="'+lectureid+'"><tr><td><button type="button" class="btn" onclick="deleteLecture(this)"><i class="fa fa-trash fa-fw"></i></button></td><td style="font-weight:bold">Session '+gid+'</td><td>'+lval+'</td></tr></table></div>');
                lecture.appendTo(gElm);
                gid = gid+1;
                $(this).prop("checked", false);
             }
             });
            });
  </script>