{% extends "__user_base.html" %}
{% load staticfiles %}

{% block active %}
<script src="{% static 'provider/js/0.3/alasql.min.js' %}"></script>
<script src="{% static 'provider/js/0.7.12/xlsx.core.min.js' %}"></script>

<script>
/* var tablesToExcel = (function() {
    var uri = 'data:application/vnd.ms-excel;base64,'
    , tmplWorkbookXML = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">'
      + '<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"><Created>{created}</Created></DocumentProperties>'
      + '<Styles>'
      + '<Style ss:ID="Currency"><NumberFormat ss:Format="Currency"></NumberFormat></Style>'
      + '<Style ss:ID="Date"><NumberFormat ss:Format="Medium Date"></NumberFormat></Style>'
      + '</Styles>' 
      + '{worksheets}</Workbook>'
    , tmplWorksheetXML = '<Worksheet ss:Name="{nameWS}"><Table>{rows}</Table></Worksheet>'
    , tmplCellXML = '<Cell{attributeStyleID}{attributeFormula}><Data ss:Type="{nameType}">{data}</Data></Cell>'
    , base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
    , format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
    return function(tables, wsnames, wbname, appname) {
      var ctx = "";
      var workbookXML = "";
      var worksheetsXML = "";
      var rowsXML = "";

      for (var i = 0; i < tables.length; i++) {
        if (!tables[i].nodeType) tables[i] = document.getElementById(tables[i]);
        for (var j = 0; j < tables[i].rows.length; j++) {
          rowsXML += '<Row>'
          for (var k = 0; k < tables[i].rows[j].cells.length; k++) {
            var dataType = tables[i].rows[j].cells[k].getAttribute("data-type");
            var dataStyle = tables[i].rows[j].cells[k].getAttribute("data-style");
            var dataValue = tables[i].rows[j].cells[k].getAttribute("data-value");
            dataValue = (dataValue)?dataValue:tables[i].rows[j].cells[k].innerHTML;
            var dataFormula = tables[i].rows[j].cells[k].getAttribute("data-formula");
            dataFormula = (dataFormula)?dataFormula:(appname=='Calc' && dataType=='DateTime')?dataValue:null;
            ctx = {  attributeStyleID: (dataStyle=='Currency' || dataStyle=='Date')?' ss:StyleID="'+dataStyle+'"':''
                   , nameType: (dataType=='Number' || dataType=='DateTime' || dataType=='Boolean' || dataType=='Error')?dataType:'String'
                   , data: (dataFormula)?'':dataValue
                   , attributeFormula: (dataFormula)?' ss:Formula="'+dataFormula+'"':''
                  };
            rowsXML += format(tmplCellXML, ctx);
          }
          rowsXML += '</Row>'
        }
        ctx = {rows: rowsXML, nameWS: wsnames[i] || 'Sheet' + i};
        worksheetsXML += format(tmplWorksheetXML, ctx);
        rowsXML = "";
      }

      ctx = {created: (new Date()).getTime(), worksheets: worksheetsXML};
      workbookXML = format(tmplWorkbookXML, ctx);
      var link = document.createElement("A");
      link.href = uri + base64(workbookXML);
      link.download = wbname || 'Workbook.xls';
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  })();

  function download_csv(csv, filename) {
    var csvFile;
    var downloadLink;

    // CSV FILE
    csvFile = new Blob([csv], {type: "text/csv"});

    // Download link
    downloadLink = document.createElement("a");

    // File name
    downloadLink.download = filename;

    // We have to create a link to the file
    downloadLink.href = window.URL.createObjectURL(csvFile);

    // Make sure that the link is not displayed
    downloadLink.style.display = "none";

    // Add the link to your DOM
    document.body.appendChild(downloadLink);

    // Lanzamos
    downloadLink.click();
}

function export_table_to_csv(tables,sheetname) {
  var csv = [];
  for (var k = 0; k < 1; k++) {
    var rowsSelector = "#"+tables[k] + " tr";
	  var rows = document.querySelectorAll(rowsSelector);
	  for (var i = 0; i < rows.length; i++) {
		  var row = [], cols = rows[i].querySelectorAll("td, th");
        for (var j = 0; j < cols.length; j++) 
            row.push(cols[j].innerText.replace(/,/g, ' '));
		    csv.push(row.join(","));		
	  }
  }
  download_csv(csv.join("\n"),'students.csv');
} */

function exportExcel(tabs,courseNames) {
    var datas = [];
    var opts = [];
    for (var i = 0; i < tabs.length; i++) {
      var sql = 'SELECT * FROM HTML("#'+ tabs[i] + '",{headers:true})';
      var data = alasql(sql);
      datas.push(data);
      var opt = {sheetid:courseNames[i],header:true};
      opts.push(opt);
    }
    var res = alasql('SELECT INTO XLSX("my_students.xlsx",?) FROM ?',[opts,datas]);
    }

function calltablestoexcel() {
  var tables = document.querySelectorAll('*[id^="studentsTable"]');
  var tabs = [];
  var courseNames = [];
  var j=1;
  for (var i=0;i<tables.length;i++) {
    tabs.push(tables[i].id);
    var courseName = document.getElementById('courseName'+String(j)).innerText;
    j=j+1;
    courseNames.push(courseName);
  }
  exportExcel(tabs,courseNames);
  //tablesToExcel(tabs, courseNames, 'students.xls', 'Excel');
}

</script>
  <!-- Breadcrumbs-->
<nav class="navbar">
  <div class="mr-lg-auto">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="#">Dashboard</a>
    </li>
    <li class="breadcrumb-item active">My Students</li>
  </ol>
</div>
<button onclick="calltablestoexcel()" class="btn btn-outline-info btn-md mx-2 px-2" aria-pressed="true"><i class="far fa-file-excel"></i> Export data</button>

</nav>

  <div class="container-fluid">
  <div class="row">
    <!-- <div class="col-1"></div> -->
    <div class="col-auto">
  <input type="text" id="filterAllStudents{{providerid}}" onkeyup="filterFunction('filterAllStudents{{providerid}}','studentsTable')" placeholder="Filter All Students..">
</div>
</div>  
</div>
<hr>
  <div class="container-fluid">
    <div style="overflow-x:auto;">
        
        {% for key, values in course_stats.items %}
    <h6 id="courseName{{forloop.counter}}">{{ key }} </h6> 
    <table id="studentsTable{{forloop.counter}}" class="table table-striped table-bordered" style="width:100%">
    <thead>
      
        <tr>
            <th scope="col">#</th>
            <th>Name</th>
            <!--<th>Session Completed</th>
            <th>Play Count</th>
            <th>Progress</th>
            <th>Total Sessions</th> -->
            <th>Joined on</th> 
            <th>Status</th>
			      <th>Available (hrs)</th>
			      <th>Viewed (mins)</th>
        </tr>
    </thead>
    <tbody>
        
        <!--<tr><th scope="row"></th>
          <td><input type="text" id="filterStudents{{forloop.counter}}" onkeyup="filterFunction('filterStudents{{forloop.counter}}','studentsTable{{forloop.counter}}')" placeholder="Filter Students..">
          </td></tr>  -->
        {% for item in values %}
        <tr>
            <th scope="row">{{forloop.counter}}</th>
            <td>{{ item.name }}</td>
            <!--<td>{{ item.totalSessionWatched }}</td>
            <td>{{ item.totalPlayedCount }}</td>
            <td>{{ item.CourseCompleted }}</td>
            <td>{{ item.totalSessions }}</td> -->
            <td>{{ item.enrolled_date }}</td> 
            <td>{{ item.remarks }}</td>
			{% if item.viewhours >  0 %}
			<td>{{ item.viewhours }}</td>
			<td>{{ item.completedminutes }}</td>
			{% else %}
			<td>NA</td>
			<td>NA</td>
      {% endif %}
      <td><a class="btn btn-primary" href="{% url 'provider:add_students' item.id %}" title="Edit Access"></a>
        </tr>
        {% endfor %}
    </tbody>
    
    </table>
    <hr>
    {% endfor %}
    </div>
    </div>
    <script src="{% static 'provider/js/createCourseContent.js' %}">


    </script>
{% endblock active %}